<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evaluaci√≥n IA | Body Elite</title>
    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: url('https://images.unsplash.com/photo-1629909613654-28e377c37b09?q=80&w=2068') no-repeat center center fixed; 
            background-size: cover; 
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        /* CONTENEDOR PRINCIPAL (FULL SCREEN EN MOVIL) */
        #z-c {
            position: relative; width: 100%; max-width: 450px; height: 100%; 
            background: #fff; display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        /* Ajuste Escritorio */
        @media (min-width: 481px) {
             #z-c { height: 85vh; border-radius: 20px; max-height: 800px; }
        }

        /* HEADER */
        #z-header { background: #111827; padding: 15px; color: white; display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .z-avatar { position: relative; width: 45px; height: 45px; }
        .z-avatar img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #22c55e; object-fit: cover; }
        .z-dot { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #22c55e; border-radius: 50%; border: 2px solid #111827; }
        
        /* CHAT AREA */
        #z-b { flex: 1; background: #efeae2; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 12px 16px; border-radius: 12px; max-width: 85%; font-size: 15px; line-height: 1.5; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .bot { align-self: flex-start; background: #fff; color: #111; border-top-left-radius: 0; }
        .user { align-self: flex-end; background: #d9fdd3; color: #111; border-top-right-radius: 0; }

        /* INPUT AREA */
        .input-area { background: #fff; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #ddd; outline: none; background: #f9fafb; font-size: 16px; }
        button { background: #075e54; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: transform 0.2s; }
        button:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="z-c">
        <div id="z-header">
            <div class="z-avatar">
                <img src="https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?q=80&w=200" alt="Z">
                <div class="z-dot"></div>
            </div>
            <div>
                <div style="font-weight:bold; font-size:16px;">Zara</div>
                <div style="font-size:12px; opacity:0.8">En l√≠nea ahora</div>
            </div>
        </div>
        
        <div id="z-b">
            </div>
        
        <div class="input-area">
            <input id="z-i" type="text" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()">‚û§</button>
        </div>
    </div>

<script>
    const API_URL = 'https://zara-bodyelite-1.onrender.com/webchat';
    
    // 1. IDENTIFICACI√ìN DE CAMPA√ëA Y USUARIO AN√ìNIMO
    const urlParams = new URLSearchParams(window.location.search);
    const REF = urlParams.get('ref') || urlParams.get('utm_campaign') || null;

    // Generamos un ID persistente para que el Monitor no se confunda si recarga
    let sessionUser = localStorage.getItem('zara_id');
    if (!sessionUser) {
        sessionUser = "Visitante " + Math.floor(Math.random() * 1000);
        localStorage.setItem('zara_id', sessionUser);
    }

    // 2. SALUDO INICIAL INTELIGENTE
    window.onload = function() {
        let saludo = "";
        
        if (REF) {
            // Si viene de anuncio (Ej: bodyelite.cl?ref=lipo)
            const campanaLimpia = REF.replace(/_/g, ' ').toUpperCase();
            saludo = `¬°Hola! üëã Veo que te interesa nuestra campa√±a de <b>${campanaLimpia}</b>.<br><br>Soy Zara. ¬øCon qui√©n tengo el gusto? ‚ú®`;
        } else {
            // Si viene directo (Org√°nico)
            saludo = "¬°Hola! üëã Bienvenida a Body Elite. Soy Zara, la asistente virtual.<br><br>¬øC√≥mo te llamas para poder ayudarte mejor? üòä";
        }

        setTimeout(() => addMsg(saludo, 'bot'), 600);
    };

    // 3. ENVIAR MENSAJE
    async function send() {
        const inp = document.getElementById('z-i');
        const txt = inp.value.trim();
        if(!txt) return;

        addMsg(txt, 'user');
        inp.value = '';

        try {
            // Indicador "Escribiendo..."
            const loadId = 'load'+Date.now();
            const box = document.getElementById('z-b');
            box.innerHTML += `<div id="${loadId}" style="font-size:12px;color:#888;margin:5px 15px">Escribiendo...</div>`;
            box.scrollTop = box.scrollHeight;

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ 
                    message: txt, 
                    userName: sessionUser, // Enviamos ID, Zara preguntar√° el nombre real
                    ref: REF 
                })
            });
            const data = await res.json();
            
            document.getElementById(loadId).remove();
            if (data.reply) addMsg(data.reply, 'bot');

        } catch (e) {
            document.querySelector('div[id^="load"]')?.remove();
            addMsg("‚ö†Ô∏è Error de conexi√≥n", 'bot');
        }
    }

    function addMsg(text, type) {
        const box = document.getElementById('z-b');
        box.innerHTML += `<div class="msg ${type}">${text}</div>`;
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
</html>
