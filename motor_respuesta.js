import fs from "fs";
import baseConocimiento from "./base_conocimiento.js";
import { registrarContexto, obtenerContexto } from "./memoria.js";

export async function responder(mensaje) {
  const t = mensaje.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

  if (t.startsWith("zara")) {
    const encontrado = baseConocimiento.find((p) => t.includes(p.activador));
    if (encontrado) {
      registrarContexto("interno", encontrado.plan);
      return `ğŸ§  [Modo interno activo]\n${encontrado.detalle}`;
    } else {
      return "ğŸ§  [Modo interno activo] No encontrÃ© un tratamiento con ese nombre. Verifica la escritura.";
    }
  }

  const saludos = ["hola", "buenas", "buen dia", "buenos dias", "buenas tardes", "buenas noches", "hey", "holi"];
  if (saludos.some((s) => t.startsWith(s))) {
    registrarContexto("saludo", "inicio conversacion");
    return "Hola ğŸ˜Š Soy Zara de Body Elite. CuÃ©ntame quÃ© zona te gustarÃ­a mejorar para orientarte con el tratamiento ideal âœ¨";
  }

  const contextoPrevio = obtenerContexto();

  const categorias = {
    corporal: [
      "abdomen","panza","rollitos","grasa","grasita","vientre","cintura","brazos",
      "flacidez","celulitis","pierna","piernas","muslo","muslos","gluteo","glÃºteo",
      "poto","trasero","cola","tonificar","endurecer"
    ],
    facial: [
      "cara","rostro","papada","arrugas","lineas","expresion","frente","ojeras",
      "manchas","piel","luminosidad","rejuvenecer"
    ],
    tecnologia: ["hifu","cavitacion","radiofrecuencia","ems","sculptor","toxina","botox","pink","led","luz"],
    curiosidad: [
      "en que consiste","como funciona","que incluye","porque tan caro","mas barato",
      "cuantas sesiones","detalle","explicame","dime mas","que es","cual me sirve","cual recomiendas"
    ],
    duda: [
      "duele","sirve para hombres","demora","puedo pagar","cuando podria",
      "no tengo tiempo","cuanto dura","efecto"
    ],
    cierre: ["gracias","ok","perfecto","genial","listo"]
  };

  if (categorias.corporal.some(p => t.includes(p))) {
    registrarContexto("corporal", "Lipo Reductiva / Body Tensor / Push Up");
    return "Hola ğŸ˜Š Esa zona se puede tratar sin cirugÃ­a âœ¨ Con nuestros planes **Lipo Reductiva**, **Body Tensor** o **Push Up**, segÃºn diagnÃ³stico. Trabajamos con **HIFU 12D, CavitaciÃ³n, RF y EMS Sculptor**, que reducen grasa y tensan la piel ğŸ’ª Resultados visibles desde las primeras sesiones. Planes desde **$348.800 (valor referencial, sujeto a evaluaciÃ³n clÃ­nica)**. Â¿Quieres agendar tu evaluaciÃ³n gratuita? ğŸ”— https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9";
  }

  if (categorias.facial.some(p => t.includes(p))) {
    registrarContexto("facial", "Face Smart / Face Antiage / Face Elite / Limpieza Facial Full");
    return "Hola ğŸ˜Š Podemos mejorar la firmeza, textura y luminosidad de tu piel âœ¨ Con nuestros planes **Face Smart**, **Face Antiage**, **Face Elite** o **Limpieza Facial Full**, segÃºn tu diagnÃ³stico. Usamos **HIFU 12D, RF fraccionada y activos antioxidantes**. Planes desde **$120.000 (valor referencial, sujeto a evaluaciÃ³n clÃ­nica)**. Â¿Quieres agendar tu evaluaciÃ³n facial gratuita? ğŸ”— https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9";
  }

  if (categorias.tecnologia.some(p => t.includes(p))) {
    registrarContexto("tecnologia", "ExplicaciÃ³n tÃ©cnica");
    return "ğŸ’¡ Trabajamos con tecnologÃ­a avanzada: **HIFU 12D, CavitaciÃ³n, Radiofrecuencia y EMS Sculptor**. Cada una actÃºa sobre grasa, mÃºsculo o colÃ¡geno segÃºn tu necesidad. Durante tu evaluaciÃ³n gratuita definimos la combinaciÃ³n ideal para ti. ğŸ”— https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9";
  }

  if (categorias.curiosidad.some(p => t.includes(p))) {
    if (contextoPrevio) {
      return `âœ¨ Este tratamiento combina ${contextoPrevio.plan} con tecnologÃ­as seguras que actÃºan por calor o ultrasonido. Las sesiones duran entre 45 y 75 min, segÃºn zona. Los resultados son progresivos y visibles desde la primera aplicaciÃ³n ğŸ’¬ Â¿Quieres reservar tu evaluaciÃ³n gratuita?`;
    }
    return "âœ¨ Es un procedimiento no invasivo que estimula colÃ¡geno y reduce grasa o flacidez segÃºn la zona. Resultados visibles desde las primeras sesiones ğŸ’¬ Â¿Quieres agendar tu evaluaciÃ³n gratuita? ğŸ”— https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9";
  }

  if (categorias.duda.some(p => t.includes(p))) {
    if (t.includes("duele")) return "No duele ğŸ˜Š SentirÃ¡s un leve calor o pequeÃ±as contracciones, pero es perfectamente tolerable. Son procedimientos no invasivos y cÃ³modos.";
    if (t.includes("hombres")) return "SÃ­ ğŸ™Œ Todos nuestros tratamientos corporales y faciales son unisex. Ajustamos parÃ¡metros segÃºn tipo de piel y estructura corporal.";
    if (t.includes("pagar")) return "SÃ­ ğŸ˜Š Puedes pagar por sesiÃ³n o en plan completo con descuento. En la evaluaciÃ³n gratuita te mostramos todas las opciones.";
    if (t.includes("tiempo")) return "Cada sesiÃ³n dura menos de una hora y no requiere recuperaciÃ³n âœ¨ Puedes venir incluso en tu hora de almuerzo.";
    return "Te cuento ğŸ˜Š los resultados dependen de la zona y plan, pero generalmente se notan desde las primeras sesiones.";
  }

  if (categorias.cierre.some(p => t.includes(p))) {
    return "Me alegra poder orientarte ğŸ˜Š Recuerda que puedes agendar tu evaluaciÃ³n gratuita cuando quieras. ğŸ”— https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9";
  }

  registrarContexto("general", "ninguno");
  return "No logrÃ© entender completamente tu mensaje, pero estoy segura de que tus dudas serÃ¡n resueltas por nuestras profesionales durante tu evaluaciÃ³n gratuita ğŸ’¬ Agenda aquÃ­ ğŸ‘‡ ğŸ”— https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9";
}
