<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Control | Body Elite</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #d1d7db; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR (LISTA DE CHATS) */
        .sidebar { width: 380px; background: white; border-right: 1px solid #d1d7db; display: flex; flex-direction: column; }
        
        .sidebar-header { 
            background: #f0f2f5; padding: 10px 16px; height: 60px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid #d1d7db; 
        }
        .header-title { font-weight: bold; color: #41525d; display: flex; align-items: center; gap: 10px; }
        .refresh-btn { 
            background: white; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; cursor: pointer; color: #54656f; transition: all 0.2s;
        }
        .refresh-btn:hover { background: #e9edef; }
        .refresh-btn:active { transform: scale(0.95); }

        /* FILTROS */
        .filters { display: flex; padding: 10px; gap: 8px; background: white; border-bottom: 1px solid #f0f2f5; overflow-x: auto; }
        .filter-chip { 
            padding: 6px 12px; border: none; background: #f0f2f5; border-radius: 20px; 
            cursor: pointer; font-size: 13px; color: #54656f; white-space: nowrap; transition: 0.2s;
        }
        .filter-chip.active { background: #e7fce3; color: #008069; font-weight: bold; }
        .filter-chip:hover:not(.active) { background: #e9edef; }

        /* LISTA */
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { 
            display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f2f5; 
            transition: background 0.2s; position: relative;
        }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; }

        .avatar { 
            width: 48px; height: 48px; background: #dfe3e5; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            margin-right: 15px; color: white; font-size: 20px; position: relative; flex-shrink: 0;
        }
        .platform-icon {
            position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; 
            border-radius: 50%; border: 2px solid white; display: flex; 
            justify-content: center; align-items: center; font-size: 11px; color: white;
        }
        .bg-wsp { background-color: #25D366; }
        .bg-ig { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); }
        .bg-web { background-color: #3498db; }

        .chat-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .chat-name { font-weight: 500; font-size: 16px; color: #111b21; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-date { font-size: 12px; color: #667781; }
        
        .row-bottom { display: flex; align-items: center; }
        .last-msg { font-size: 13px; color: #667781; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .tag-ads { background: #fff8c5; color: #856404; border: 1px solid #ffeeba; }

        /* MAIN AREA (CONVERSACI칍N) */
        .main { flex: 1; display: flex; flex-direction: column; background: #efeae2; border-left: 1px solid #d1d7db; position: relative; }
        .main-header { 
            background: #f0f2f5; height: 60px; padding: 0 20px; display: flex; align-items: center; 
            border-bottom: 1px solid #d1d7db; gap: 15px; 
        }
        .header-info h2 { margin: 0; font-size: 16px; font-weight: 600; }
        .header-info p { margin: 0; font-size: 12px; color: #667781; }

        .messages-area { 
            flex: 1; padding: 20px 50px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; 
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-repeat: repeat; opacity: 0.95;
        }

        .msg-bubble { 
            max-width: 65%; padding: 8px 12px; border-radius: 7.5px; 
            font-size: 14px; line-height: 1.4; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); 
            word-wrap: break-word;
        }
        .msg-in { align-self: flex-start; background: white; border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-right-radius: 0; }
        
        .msg-meta { 
            display: flex; justify-content: flex-end; gap: 5px; margin-top: 2px; 
            font-size: 11px; color: #667781; 
        }

        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #667781; text-align: center;
        }
        .empty-state i { font-size: 60px; margin-bottom: 20px; opacity: 0.3; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="header-title">
                <i class="fa-solid fa-tower-observation"></i> Monitor Body Elite
            </div>
            <button class="refresh-btn" onclick="fetchData()" title="Actualizar ahora">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
        
        <div class="filters">
            <button class="filter-chip active" onclick="setFilter('all', this)">Todos</button>
            <button class="filter-chip" onclick="setFilter('whatsapp', this)">WhatsApp</button>
            <button class="filter-chip" onclick="setFilter('instagram', this)">Instagram</button>
            <button class="filter-chip" onclick="setFilter('web', this)">Web</button>
        </div>

        <div class="chat-list" id="chatList">
            <div style="padding:20px; text-align:center; color:#999;">Cargando chats...</div>
        </div>
    </div>

    <div class="main">
        <div class="main-header" id="mainHeader" style="display:none;">
            <div class="avatar" style="width:40px; height:40px; font-size:16px;">
                <span id="headAvatar">User</span>
            </div>
            <div class="header-info">
                <h2 id="headName">Selecciona un chat</h2>
                <p id="headDetail">...</p>
            </div>
        </div>

        <div class="messages-area" id="msgArea">
            <div class="empty-state">
                <i class="fa-brands fa-whatsapp"></i>
                <h3>Monitor Inteligente V1</h3>
                <p>Selecciona una conversaci칩n para ver el historial y la campa침a de origen.</p>
                <p style="font-size:12px; margin-top:10px;">Autorefresh: 15s (Modo Starter)</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI칍N
        const API_URL = "https://zara-bodyelite-1.onrender.com/api/monitor";
        let rawData = [];
        let currentFilter = 'all';
        let selectedChatId = null;

        // INICIAR
        fetchData();
        setInterval(fetchData, 15000); // Polling cada 15 seg para cuidar Render Starter

        async function fetchData() {
            try {
                const btn = document.querySelector('.refresh-btn i');
                btn.classList.add('fa-spin'); // Feedback visual

                const response = await fetch(API_URL);
                rawData = await response.json();
                
                renderChatList();
                if (selectedChatId) renderMessages(selectedChatId); // Refrescar chat abierto

                setTimeout(() => btn.classList.remove('fa-spin'), 500);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function setFilter(type, btn) {
            currentFilter = type;
            // Actualizar clases botones
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderChatList();
        }

        function renderChatList() {
            const list = document.getElementById('chatList');
            list.innerHTML = '';

            // Filtrar
            const filtered = rawData.filter(chat => currentFilter === 'all' || chat.plataforma === currentFilter);

            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No hay chats recientes</div>';
                return;
            }

            filtered.forEach(chat => {
                const lastMsg = chat.mensajes[chat.mensajes.length - 1];
                const time = new Date(lastMsg.fecha).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const isActive = chat.id === selectedChatId ? 'active' : '';
                
                // Icono Plataforma
                let icon = '';
                let bgClass = '';
                if(chat.plataforma === 'whatsapp') { icon = 'fa-whatsapp'; bgClass = 'bg-wsp'; }
                else if(chat.plataforma === 'instagram') { icon = 'fa-instagram'; bgClass = 'bg-ig'; }
                else { icon = 'fa-globe'; bgClass = 'bg-web'; }

                // Tag Campa침a
                let campanaTag = '';
                if (chat.campana && chat.campana !== 'Org치nico') {
                    campanaTag = `<span class="tag tag-ads"><i class="fa-solid fa-bullhorn"></i> ${chat.campana}</span>`;
                }

                const html = `
                <div class="chat-item ${isActive}" onclick="selectChat('${chat.id}')">
                    <div class="avatar ${bgClass}">
                        ${chat.nombre.charAt(0).toUpperCase()}
                        <div class="platform-icon ${bgClass}"><i class="fa-brands ${icon}"></i></div>
                    </div>
                    <div class="chat-info">
                        <div class="row-top">
                            <div class="chat-name">${chat.nombre}</div>
                            <div class="chat-date">${time}</div>
                        </div>
                        <div class="row-bottom">
                            <div class="last-msg">
                                ${lastMsg.remite === 'zara' ? '<i class="fa-solid fa-check-double" style="color:#53bdeb; font-size:10px;"></i>' : ''} 
                                ${lastMsg.texto}
                            </div>
                            ${campanaTag}
                        </div>
                    </div>
                </div>`;
                list.innerHTML += html;
            });
        }

        function selectChat(id) {
            selectedChatId = id;
            renderChatList(); // Para actualizar el 'active' visual
            renderMessages(id);
        }

        function renderMessages(id) {
            const chat = rawData.find(c => c.id === id);
            if (!chat) return;

            // Header update
            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('headName').innerText = chat.nombre;
            document.getElementById('headAvatar').innerText = chat.nombre.charAt(0).toUpperCase();
            
            let origenTexto = `Canal: ${chat.plataforma.toUpperCase()}`;
            if(chat.campana && chat.campana !== 'Org치nico') {
                origenTexto += ` | 游닉 CAMPA칌A ADS: ${chat.campana.toUpperCase()}`;
                document.getElementById('headDetail').style.color = '#d32f2f'; // Rojo para destacar Ads
                document.getElementById('headDetail').style.fontWeight = 'bold';
            } else {
                document.getElementById('headDetail').style.color = '#667781';
                document.getElementById('headDetail').style.fontWeight = 'normal';
            }
            document.getElementById('headDetail').innerText = origenTexto;

            // Messages update
            const box = document.getElementById('msgArea');
            box.innerHTML = ''; // Limpiar

            chat.mensajes.forEach(m => {
                const typeClass = m.remite === 'zara' ? 'msg-out' : 'msg-in';
                const time = new Date(m.fecha).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const html = `
                <div class="msg-bubble ${typeClass}">
                    <div>${m.texto}</div>
                    <div class="msg-meta">
                        <span>${time}</span>
                    </div>
                </div>`;
                box.innerHTML += html;
            });

            // Scroll al fondo
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
