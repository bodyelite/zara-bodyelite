import fs from "fs";

const conocimientos = JSON.parse(fs.readFileSync("./conocimientos.json", "utf8"));
const frases = JSON.parse(fs.readFileSync("./frases.json", "utf8"));

const planes = conocimientos.planes;
const zonas = conocimientos.problema_zona;
const alias = conocimientos.alias_zonas;
const info = conocimientos.informacion_general;

export function generarRespuesta(texto) {
  const msg = texto.toLowerCase().trim();

  // --- 1. Bienvenida ---
  if (frases.bienvenida.some(t => msg.includes(t))) {
    return "üëã Hola, soy Zara IA de Body Elite. Cu√©ntame qu√© zona deseas mejorar y te recomendar√© el tratamiento m√°s adecuado seg√∫n diagn√≥stico asistido por IA.";
  }

  // --- 2. Detectar zona (directa o por alias) ---
  let zona = Object.keys(zonas).find(z => msg.includes(z));
  if (!zona) {
    for (const [aliasTerm, zonaReal] of Object.entries(alias)) {
      if (msg.includes(aliasTerm)) {
        zona = zonaReal;
        break;
      }
    }
  }

  // --- 3. Si se identific√≥ zona, buscar problema y planes ---
  if (zona) {
    const problemas = zonas[zona];
    for (const [clave, listaPlanes] of Object.entries(problemas)) {
      if (msg.includes(clave)) {
        const principal = planes[listaPlanes[0]];
        const alternativo = listaPlanes[1] ? planes[listaPlanes[1]] : null;

        let respuesta = `‚ú® Para ${zona} con ${clave}, te recomiendo el plan **${listaPlanes[0]}**.\n${principal.descripcion}\n`;
        if (alternativo) {
          respuesta += `Tambi√©n puedes considerar **${listaPlanes[1]}**, seg√∫n diagn√≥stico asistido por IA.\n`;
        }
        respuesta += `üìÖ Agenda tu evaluaci√≥n gratuita asistida con IA üëâ https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9`;
        return respuesta;
      }
    }

    // --- Zona detectada pero sin palabra problema ---
    const primerPlan = Object.values(problemas)[0][0];
    const plan = planes[primerPlan];
    return `‚ú® Para ${zona}, te recomiendo el plan **${primerPlan}**.\n${plan.descripcion}\nüìÖ Agenda tu evaluaci√≥n gratuita asistida con IA üëâ https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9`;
  }

  // --- 4. Preguntas frecuentes comerciales ---
  if (frases.precio.some(t => msg.includes(t))) {
    return "üí∞ Nuestros planes parten desde $120.000 (faciales) y $348.800 (corporales). Incluyen diagn√≥stico gratuito asistido por IA.";
  }
  if (frases.ubicacion.some(t => msg.includes(t))) {
    return `üìç ${info.direccion}\nüïí ${info.horarios}`;
  }
  if (frases.horarios.some(t => msg.includes(t))) {
    return `üïí Horarios de atenci√≥n: ${info.horarios}`;
  }
  if (frases.humano.some(t => msg.includes(t))) {
    return `üìû Puedes hablar con un especialista al ${info.telefono_humano}`;
  }

  // --- 5. Preguntas de tipo comercial general ---
  if (frases.faq_comercial.some(t => msg.includes(t))) {
    return "üíÜ En Body Elite utilizamos HIFU 12D, Cavitaci√≥n, Radiofrecuencia y EMS Sculptor para resultados visibles desde la primera sesi√≥n, sin cirug√≠a ni dolor.";
  }

  // --- 6. Mensaje gen√©rico ---
  return "‚ú® Soy Zara IA de Body Elite. Cu√©ntame qu√© zona deseas mejorar (rostro, abdomen, gl√∫teos, etc.) y te indicar√© el tratamiento ideal con descripci√≥n cl√≠nica y valor.";
}
