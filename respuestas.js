import fs from "fs";

const conocimientos = JSON.parse(fs.readFileSync("./conocimientos.json", "utf8"));
const frases = JSON.parse(fs.readFileSync("./frases.json", "utf8"));

const planes = conocimientos.planes;
const zonas = conocimientos.problema_zona;
const alias = conocimientos.alias_zonas;
const info = conocimientos.informacion_general;

// --- Funci√≥n principal ---
export function generarRespuesta(texto) {
  const msg = texto.toLowerCase().trim();

  // --- 1. Bienvenida ---
  if (frases.bienvenida.some(t => msg.includes(t))) {
    return "üëã Hola, soy Zara IA de Body Elite. Cu√©ntame qu√© zona quieres mejorar y te orientar√© con el tratamiento ideal seg√∫n diagn√≥stico cl√≠nico y tecnolog√≠a aplicada.";
  }

  // --- 2. Detecci√≥n de zona ---
  let zona = Object.keys(zonas).find(z => msg.includes(z));
  if (!zona) {
    for (const [aliasTerm, zonaReal] of Object.entries(alias)) {
      if (msg.includes(aliasTerm)) {
        zona = zonaReal;
        break;
      }
    }
  }

  // --- 3. Si se identific√≥ zona, buscar problema y plan ---
  if (zona) {
    const problemas = zonas[zona];
    for (const [clave, listaPlanes] of Object.entries(problemas)) {
      if (msg.includes(clave)) {
        const plan = planes[listaPlanes[0]];
        if (plan) {
          return `üí° *Tratamiento recomendado: ${listaPlanes[0]}*\n${plan.descripcion}\nüí∞ Valor: ${plan.precio}\nüìÖ Agenda tu evaluaci√≥n gratuita aqu√≠ üëâ https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9`;
        }
      }
    }

    // sin problema expl√≠cito, responder gen√©rico por zona
    const primerPlan = Object.values(problemas)[0][0];
    const plan = planes[primerPlan];
    if (plan) {
      return `‚ú® Para ${zona}, recomendamos *${primerPlan}*.\n${plan.descripcion}\nüí∞ Valor: ${plan.precio}\nüìÖ Agenda tu evaluaci√≥n gratuita aqu√≠ üëâ https://agendamiento.reservo.cl/makereserva/agenda/f0Hq15w0M0nrxU8d7W64x5t2S6L4h9`;
    }
  }

  // --- 4. Preguntas comerciales ---
  if (frases.precio.some(t => msg.includes(t))) {
    return "üí∞ Nuestros planes parten desde $120.000 (faciales) y $348.800 (corporales). Incluyen diagn√≥stico gratuito asistido con IA.";
  }
  if (frases.ubicacion.some(t => msg.includes(t))) {
    return `üìç ${info.direccion}\nüïí ${info.horarios}`;
  }
  if (frases.horarios.some(t => msg.includes(t))) {
    return `üïí Horarios de atenci√≥n: ${info.horarios}`;
  }
  if (frases.humano.some(t => msg.includes(t))) {
    return `üìû Puedes hablar con un especialista al ${info.telefono_humano}`;
  }

  // --- 5. Consultas generales de funcionamiento ---
  if (frases.faq_comercial.some(t => msg.includes(t))) {
    return "üíÜ En Body Elite usamos HIFU 12D, Cavitaci√≥n, Radiofrecuencia y EMS Sculptor para lograr resultados cl√≠nicos reales sin cirug√≠a ni dolor.";
  }

  // --- 6. Mensaje gen√©rico ---
  return "‚ú® Soy Zara IA de Body Elite. Cu√©ntame qu√© zona deseas mejorar (rostro, abdomen, gl√∫teos, etc.) y te indicar√© el tratamiento ideal con descripci√≥n y valor.";
}
